{% extends 'accounts/base.html' %}
{% block content %}

<!-- MAGIC STYLING FOR DJANGO FORMS (No backend changes required!) -->
<style>
    /* Force Django output variables to look like Tailwind inputs */
    #multiStepForm input:not([type="checkbox"]):not([type="radio"]):not([type="file"]),
    #multiStepForm select,
    #multiStepForm textarea {
        width: 100%;
        background-color: rgba(249, 250, 251, 0.5); /* bg-gray-50/50 */
        border: 1px solid #e5e7eb; /* border-gray-200 */
        border-radius: 1rem; /* rounded-2xl */
        padding: 1rem 1.25rem; /* px-5 py-4 */
        font-size: 0.875rem; /* text-sm */
        font-weight: 500;
        color: #111827;
        transition: all 0.2s;
    }
    #multiStepForm input:focus,
    #multiStepForm select:focus,
    #multiStepForm textarea:focus {
        outline: none;
        border-color: #9ca3af;
        box-shadow: 0 0 0 4px #f3f4f6; /* ring-4 ring-gray-100 */
    }
    #multiStepForm input[type="file"]::file-selector-button {
        background-color: #111827;
        color: white;
        padding: 0.5rem 1rem;
        border-radius: 0.75rem;
        border: none;
        font-weight: 700;
        cursor: pointer;
        margin-right: 1rem;
        transition: background-color 0.2s;
    }
    #multiStepForm input[type="file"]::file-selector-button:hover { background-color: #1f2937; }
    #multiStepForm input[type="checkbox"] {
        width: 1.25rem;
        height: 1.25rem;
        border-radius: 0.25rem;
        border: 1px solid #d1d5db;
        accent-color: #000;
        cursor: pointer;
    }
    
    /* JS Validation Class */
    .is-invalid {
        border-color: #ef4444 !important;
        --tw-ring-color: #fee2e2 !important;
        --tw-ring-shadow: var(--tw-ring-inset) 0 0 0 calc(4px + var(--tw-ring-offset-width)) var(--tw-ring-color) !important;
        box-shadow: var(--tw-ring-offset-shadow), var(--tw-ring-shadow), var(--tw-shadow, 0 0 #0000) !important;
    }
</style>

<div class="max-w-4xl mx-auto px-4 py-12 sm:py-20 min-h-screen">

    <!-- TITLE SECTION -->
    <div class="text-center mb-12">
        <h1 class="text-3xl sm:text-4xl font-extrabold text-gray-900 tracking-tight">Letâ€™s get you started</h1>
        <p class="text-sm text-gray-500 font-medium mt-3">
            Enter your details to register for the new academic year
        </p>
    </div>

    <!-- STEP INDICATOR -->
    <div class="flex items-center justify-center mb-12 overflow-x-auto">
        <div class="flex items-center space-x-2 sm:space-x-4">
            
            <div id="step1Indicator" class="rounded-full bg-black text-white flex items-center justify-center w-10 h-10 font-bold shadow-sm transition-all duration-300">1</div>
            <span id="step1Text" class="font-bold text-black text-xs sm:text-sm uppercase tracking-wide">Personal Details</span>

            <div class="w-8 sm:w-16 border-t-2 border-gray-200"></div>

            <div id="step2Indicator" class="rounded-full bg-gray-100 text-gray-400 flex items-center justify-center w-10 h-10 font-bold transition-all duration-300">2</div>
            <span id="step2Text" class="font-bold text-gray-400 text-xs sm:text-sm uppercase tracking-wide hidden sm:block">Academic Info</span>

            <div class="w-8 sm:w-16 border-t-2 border-gray-200"></div>

            <div id="step3Indicator" class="rounded-full bg-gray-100 text-gray-400 flex items-center justify-center w-10 h-10 font-bold transition-all duration-300">3</div>
            <span id="step3Text" class="font-bold text-gray-400 text-xs sm:text-sm uppercase tracking-wide hidden sm:block">Security</span>

        </div>
    </div>

    <!-- CARD -->
    <div class="bg-white/90 backdrop-blur-xl rounded-[2rem] p-8 sm:p-10 shadow-[0_8px_30px_rgb(0,0,0,0.08)] border border-white relative mb-20">
        
        <form method="POST" enctype="multipart/form-data" id="multiStepForm">
            {% csrf_token %}
            
            {% if form.errors %}
            <div class="px-5 py-4 rounded-2xl font-semibold bg-red-50 text-red-700 mb-8 text-sm border border-red-100 shadow-sm">
                {{ form.errors }}
            </div>
            {% endif %}

            <!-- STEP 1: Personal Details -->
            <div class="step">
                <!-- PROFILE SECTION -->
                <div class="border border-gray-200 rounded-[1.5rem] p-6 mb-8 bg-gray-50/50 flex flex-col sm:flex-row sm:items-center">
                    <div class="mr-6 shrink-0 mb-4 sm:mb-0">
                        <img id="previewImage" src="" class="rounded-full bg-gray-200 object-cover w-20 h-20 border-2 border-white shadow-sm">
                    </div>
                    <div>
                        <h6 class="font-bold text-gray-900 text-sm mb-1">Profile Picture</h6>
                        <p class="text-gray-500 text-xs font-medium mb-3">Upload a clear passport-size photo (JPG/PNG, Max 2MB)</p>
                        {{ form.profile_picture }}
                    </div>
                </div>

                <!-- PERSONAL FIELDS -->
                <div class="grid grid-cols-1 md:grid-cols-12 gap-6">
                    <div class="md:col-span-6">
                        <label class="block text-[11px] font-bold text-gray-400 uppercase tracking-widest mb-2.5 ml-1">First name <span class="text-red-500">*</span></label>
                        {{ form.first_name }}
                    </div>
                    <div class="md:col-span-6">
                        <label class="block text-[11px] font-bold text-gray-400 uppercase tracking-widest mb-2.5 ml-1">Last name <span class="text-red-500">*</span></label>
                        {{ form.last_name }}
                    </div>
                    <div class="md:col-span-12">
                        <label class="block text-[11px] font-bold text-gray-400 uppercase tracking-widest mb-2.5 ml-1">Email <span class="text-red-500">*</span></label>
                        {{ form.email }}
                    </div>
                    <div class="md:col-span-4">
                        <label class="block text-[11px] font-bold text-gray-400 uppercase tracking-widest mb-2.5 ml-1">Age</label>
                        {{ form.age }}
                    </div>
                    <div class="md:col-span-4">
                        <label class="block text-[11px] font-bold text-gray-400 uppercase tracking-widest mb-2.5 ml-1">Gender <span class="text-red-500">*</span></label>
                        {{ form.gender }}
                    </div>
                    <div class="md:col-span-4">
                        <label class="block text-[11px] font-bold text-gray-400 uppercase tracking-widest mb-2.5 ml-1">Phone</label>
                        {{ form.phone_number }}
                    </div>
                </div>
            </div>

            <!-- STEP 2: Academic Info -->
            <div class="step hidden">
                <div class="grid grid-cols-1 md:grid-cols-12 gap-6">
                    <div class="md:col-span-6">
                        <label class="block text-[11px] font-bold text-gray-400 uppercase tracking-widest mb-2.5 ml-1">Registration Number <span class="text-red-500">*</span></label>
                        {{ form.reg_number }}
                    </div>
                    <div class="md:col-span-6">
                        <label class="block text-[11px] font-bold text-gray-400 uppercase tracking-widest mb-2.5 ml-1">Department <span class="text-red-500">*</span></label>
                        {{ form.department }}
                    </div>
                    <div class="md:col-span-6">
                        <label class="block text-[11px] font-bold text-gray-400 uppercase tracking-widest mb-2.5 ml-1">Year of Admission <span class="text-red-500">*</span></label>
                        {{ form.year_of_admission }}
                    </div>
                </div>
            </div>

            <!-- STEP 3: Security & Submit -->
            <div class="step hidden">
                <div class="grid grid-cols-1 md:grid-cols-12 gap-6">
                    <div class="md:col-span-6">
                        <label class="block text-[11px] font-bold text-gray-400 uppercase tracking-widest mb-2.5 ml-1">Password <span class="text-red-500">*</span></label>
                        {{ form.password1 }}
                    </div>
                    <div class="md:col-span-6">
                        <label class="block text-[11px] font-bold text-gray-400 uppercase tracking-widest mb-2.5 ml-1">Confirm Password <span class="text-red-500">*</span></label>
                        {{ form.password2 }}
                    </div>
                </div>

                <div class="flex items-center space-x-3 mt-8 p-4 bg-gray-50 rounded-2xl border border-gray-100">
                    {{ form.agree }}
                    <label class="text-sm font-bold text-gray-700 cursor-pointer">
                        I agree to the terms and conditions
                    </label>
                </div>
            </div>

            <!-- BUTTONS -->
            <div class="flex justify-between items-center mt-10 pt-6 border-t border-gray-100">
                <button type="button" class="px-6 py-3 rounded-2xl text-sm font-bold border-2 border-gray-200 text-gray-600 hover:bg-gray-50 hover:border-gray-300 transition-all" id="prevBtn" onclick="nextPrev(-1)">
                    Back
                </button>

                <!-- Container to align Next/Submit to the right -->
                <div class="ml-auto">
                    <button type="button" class="px-8 py-3 rounded-2xl text-sm font-bold bg-black text-white shadow-[0_4px_14px_0_rgb(0,0,0,0.39)] hover:shadow-[0_6px_20px_rgba(0,0,0,0.23)] hover:bg-gray-800 hover:-translate-y-0.5 transition-all duration-200" id="nextBtn" onclick="nextPrev(1)">
                        Continue
                    </button>

                    <button type="submit" class="px-8 py-3 rounded-2xl text-sm font-bold bg-[#B5FF9D] text-green-950 shadow-[0_4px_14px_0_rgb(181,255,157,0.39)] hover:shadow-[0_6px_20px_rgba(181,255,157,0.4)] hover:bg-[#a3eb8d] hover:-translate-y-0.5 transition-all duration-200 hidden" id="submitBtn">
                        Submit Registration
                    </button>
                </div>
            </div>

        </form>

    </div>
</div>

<!-- SCRIPT (Logic unchanged - updated purely for Tailwind class mapping) -->
<script>
let currentStep = 0;

document.addEventListener("DOMContentLoaded", function () {
    showStep(currentStep);

    // PROFILE IMAGE PREVIEW
    const fileInput = document.querySelector('input[type="file"]');
    const previewImage = document.getElementById("previewImage");

    if (fileInput && previewImage) {
        fileInput.addEventListener("change", function (e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function (event) {
                    previewImage.src = event.target.result;
                };
                reader.readAsDataURL(file);
            }
        });
    }
});

function showStep(n) {
    let steps = document.getElementsByClassName("step");

    for (let i = 0; i < steps.length; i++) {
        steps[i].classList.add("hidden");
    }

    steps[n].classList.remove("hidden");

    document.getElementById("prevBtn").style.display = n === 0 ? "none" : "inline-block";

    if (n === (steps.length - 1)) {
        document.getElementById("nextBtn").classList.add("hidden");
        document.getElementById("submitBtn").classList.remove("hidden");
    } else {
        document.getElementById("nextBtn").classList.remove("hidden");
        document.getElementById("submitBtn").classList.add("hidden");
    }

    updateIndicator(n);
}

function nextPrev(n) {
    // If moving forward, validate first
    if (n === 1 && !validateStep()) {
        return false;
    }
    currentStep = currentStep + n;
    showStep(currentStep);
}

function validateStep() {
    let steps = document.getElementsByClassName("step");
    let inputs = steps[currentStep].querySelectorAll("input, select, textarea");
    let valid = true;

    inputs.forEach(function (input) {
        input.classList.remove("is-invalid");

        // Required field check
        if (input.hasAttribute("required")) {
            if (!input.value.trim()) {
                input.classList.add("is-invalid");
                valid = false;
            }
        }

        // Checkbox validation
        if (input.type === "checkbox" && input.required) {
            if (!input.checked) {
                input.classList.add("is-invalid");
                valid = false;
            }
        }
    });

    return valid;
}

function updateIndicator(n) {
    let indicators =[
        document.getElementById("step1Indicator"),
        document.getElementById("step2Indicator"),
        document.getElementById("step3Indicator")
    ];
    let texts =[
        document.getElementById("step1Text"),
        document.getElementById("step2Text"),
        document.getElementById("step3Text")
    ];

    indicators.forEach((el, index) => {
        if (index <= n) {
            // Active Step
            el.classList.remove("bg-gray-100", "text-gray-400");
            el.classList.add("bg-black", "text-white");
            texts[index].classList.remove("text-gray-400");
            texts[index].classList.add("text-black");
        } else {
            // Inactive Step
            el.classList.remove("bg-black", "text-white");
            el.classList.add("bg-gray-100", "text-gray-400");
            texts[index].classList.remove("text-black");
            texts[index].classList.add("text-gray-400");
        }
    });
}
</script>

{% endblock %}